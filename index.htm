<!doctype html5>
<html>
    <head>
        <title>locationtest</title>
        <meta charset="UTF-8"> 
        <link rel="stylesheet" type="text/css" href="style/style.css">
        <link rel="stylesheet" type="text/css" href="style/bbui.css">

		<script type="text/javascript" src="local:///chrome/webworks.js"></script>
        <script src="js/bbui.js" type="text/javascript"></script>
        <script src="js/sensorlog.js" type="text/javascript"></script>

        <script src="js/jquery.js" type="text/javascript"></script>
        <script src="js/underscore_1.4.3.js" type="text/javascript"></script>
        <script src="js/backbone_0.9.9.js" type="text/javascript"></script>

		<script type="text/javascript">
            document.addEventListener('webworksready', 
                function(e) 
                {
                    bb.init({
                        actionBarDark: true,
                        controlsDark: true,
                        listsDark: true,
                        ondomready: function() {
                            App.init();
                        },
                        onscreenready : function(element, id, params) {
                            App.screens.prev = App.screens.cur;
                            App.screens.cur = id;

                            if(id == App.screens.settings) {
                                SensorLog.stop();
                                App.load_settings(element);
                            }

                            if(App.screens.prev == App.screens.settings) {
                                App.save_settings();
                            }
                        }
                    });
                    console.log(blackberry);
                    bb.pushScreen('screen_main.htm', 'main');
                }, 
                false);

            window.App = {
                // Keep track of which screens we came from
                screens: {
                    settings: 'settings',
                    prev: '',
                    cur: ''
                },
                dom: {},
                data: {
                    timer: undefined
                },

                init: function() {  
                    var that = this;

                    this.sensor_log = SensorLog.init();  

                    this.dom.$output = jQuery('#output');
                    this.dom.$titlebar = jQuery('#titlebar');
                    this.dom.$data_table = jQuery('#data_table>tbody');

                    //this.show_data(this.sensor_log.latest_data());
                    this.generate_data_table(this.sensor_log.all_data());
                    
                    document.addEventListener('SensorLog:new_data', function(e) {
                        that.show_data(e.data);
                    });
                },

                toggle_logging: function() {
                    SensorLog.toggle();
                    if (SensorLog.data.timer === undefined) {
                        this.dom.$titlebar[0].setActionCaption("Start");

                    } else {
                        this.dom.$titlebar[0].setActionCaption("Stop");
                    }
                },

                show_data: function(data) {
                    this.dom.$output.html(data);
                    this.dom.$data_table[0].insertBefore(
                        this.generate_table_row(data),
                        this.dom.$data_table[0].rows[0]);
                },

                generate_data_table: function(data) {
                    var row, cell;

                    for(var i=0; i<data.length; i++) {
                        if(data[i].coords === undefined) continue;

                        row = this.generate_table_row(data[i]);
                        this.dom.$data_table[0].appendChild(row);
                    }
                },

                generate_table_row: function(data) {
                    var row, cell;
                    row = document.createElement('tr');
                        
                    cell = document.createElement('td');
                    cell.innerHTML = data.coords.latitude;
                    row.appendChild(cell);

                    cell = document.createElement('td');
                    cell.innerHTML = data.coords.longitude;
                    row.appendChild(cell);

                    cell = document.createElement('td');
                    cell.innerHTML = data.comment;

                    return row;
                },

                ////////// Helper methods
                show_settings: function(){
                    bb.pushScreen('screen_settings.htm', this.screens.settings);
                },

                load_settings: function(screen) {
                    $(screen).find('#settings_delay').val(SensorLog.data.delay);

                    this.settings = SettingsController.init(screen);
                    //this.settings.generate_data_table(SensorLog.all_data());
                },

                save_settings: function(){
                    SensorLog.data.delay = Number($('#settings_delay').val());

                    delete this.settings;
                },

                clear_data: function() {
                    SensorLog.clear_data();
                },

                dump_data: function() {
                    alert(SensorLog.data_as_string());
                },

            }

            window.SettingsController = {
                dom: {
                    data_table: undefined
                },

                init: function(screen){
                    this.context = screen;
                    this.dom_init();
                    return this;
                },

                dom_init: function() {
                    this.dom.data_table = $(this.context).find('tbody');
                },

                generate_data_table: function(data) {
                    var row, cell;

                    for(var i=0; i<data.length; i++) {
                        d = data[i].coords;
                        row = document.createElement('tr');
                        
                        cell = document.createElement('td');
                        cell.innerHTML = d.latitude;
                        row.appendChild(cell);

                        cell = document.createElement('td');
                        cell.innerHTML = d.longitude;
                        row.appendChild(cell);

                        cell = document.createElement('td');
                        cell.innerHTML = d.comment;
                        
                        this.dom.data_table[0].appendChild(row);
                    }
                }
            }
		</script>
    </head>
    <body></body>
</html>
